<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools - 多機能PDF編集ツール</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF-Lib -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <!-- PDF.js (ページプレビュー用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.js worker設定
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- SortableJS (ドラッグ＆ドロップ用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- JSZip & FileSaver (Zip圧縮・ダウンロード用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts (Noto Sans JP) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
        }
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 4px; /* 横スクロール用 */
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* ドラッグ中のスタイル */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e2e8f0;
        }
        .sortable-drag {
            cursor: grabbing;
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* ページ選択時のスタイル */
        .page-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            ring: 2px solid #3b82f6;
        }
        .page-preview-canvas {
            transition: transform 0.3s ease;
        }
        /* 横スクロールコンテナの微調整 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm z-20 relative">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-xl shadow-md shadow-blue-200">
                    <i class="fa-solid fa-file-pdf text-xl"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">PDF Tools</h1>
            </div>
            <a href="#" onclick="location.reload()" class="text-sm text-slate-500 hover:text-blue-600 transition bg-slate-50 px-3 py-2 rounded-lg hover:bg-slate-100">
                <i class="fa-solid fa-rotate-right mr-1"></i> リセット
            </a>
        </div>
        
        <!-- ナビゲーションメニュー（セグメンテッドコントロール風） -->
        <div class="px-4 pb-6 bg-white">
            <div class="max-w-max mx-auto bg-slate-100 p-1.5 rounded-2xl flex overflow-x-auto no-scrollbar shadow-inner gap-1">
                <button onclick="switchTab('merge')" class="tab-btn active px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 flex items-center gap-2 whitespace-nowrap bg-white text-blue-600 shadow-sm" data-tab="merge">
                    <i class="fa-solid fa-layer-group"></i> 結合
                </button>
                <button onclick="switchTab('split')" class="tab-btn px-6 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-slate-700" data-tab="split">
                    <i class="fa-solid fa-scissors"></i> 分割
                </button>
                <button onclick="switchTab('organize')" class="tab-btn px-6 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-slate-700" data-tab="organize">
                    <i class="fa-solid fa-table-cells-large"></i> 整理
                </button>
                <button onclick="switchTab('convert')" class="tab-btn px-6 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-slate-700" data-tab="convert">
                    <i class="fa-solid fa-right-left"></i> 変換
                </button>
                <button onclick="switchTab('number')" class="tab-btn px-6 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-slate-700" data-tab="number">
                    <i class="fa-solid fa-hashtag"></i> 番号
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツエリア -->
    <main class="flex-1 overflow-hidden relative w-full max-w-4xl mx-auto p-4">
        
        <!-- =======================
             タブ: 結合 (Merge)
        ======================== -->
        <div id="tab-merge" class="tab-content h-full flex flex-col gap-4">
            <div class="text-center py-2 hidden sm:block shrink-0">
                <p class="text-slate-500 text-sm">複数のPDFファイルをアップロードして、リストをドラッグして順番を並び替え、1つのファイルに結合します。</p>
            </div>

            <!-- 結合用ドロップゾーン -->
            <div id="drop-zone-merge" class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-6 text-center transition-all duration-200 cursor-pointer hover:border-blue-400 hover:bg-slate-50 flex flex-col items-center justify-center gap-2 shrink-0">
                <input type="file" id="file-input-merge" class="hidden" multiple accept="application/pdf">
                <div class="w-14 h-14 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-2xl mb-2 pointer-events-none">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <h2 class="text-base font-bold text-slate-700 pointer-events-none">PDFを追加</h2>
                <p class="text-xs text-slate-400 pointer-events-none">ドラッグ＆ドロップ または クリック</p>
            </div>

            <!-- ファイルリスト -->
            <div class="flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col min-h-0">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                        <i class="fa-solid fa-list-ul text-slate-400"></i> ファイル一覧
                        <span id="file-count-merge" class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">0</span>
                    </h3>
                    <button id="clear-btn-merge" class="text-xs text-red-500 hover:text-red-700 font-medium hidden transition hover:bg-red-50 px-2 py-1 rounded">
                        <i class="fa-regular fa-trash-can mr-1"></i>すべて削除
                    </button>
                </div>
                <div id="file-list-merge" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div id="empty-state-merge" class="h-full flex flex-col items-center justify-center text-slate-300 py-6">
                        <i class="fa-regular fa-file-pdf text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">ファイルがまだありません</p>
                    </div>
                </div>
            </div>

            <div class="shrink-0 pt-2">
                <button id="btn-exec-merge" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-slate-200 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2 text-base" disabled>
                    <i class="fa-solid fa-file-export"></i> 結合してダウンロード
                </button>
            </div>
        </div>


        <!-- =======================
             タブ: 分割 (Split)
        ======================== -->
        <div id="tab-split" class="tab-content h-full hidden flex-col gap-4">
            <div class="text-center py-2 hidden sm:block shrink-0">
                <p class="text-slate-500 text-sm">PDFファイルを1つアップロードし、分割方法を選択してください。</p>
            </div>

            <div id="drop-zone-split" class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-6 text-center transition-all duration-200 cursor-pointer hover:border-blue-400 hover:bg-slate-50 flex flex-col items-center justify-center gap-2 shrink-0">
                <input type="file" id="file-input-split" class="hidden" accept="application/pdf">
                <div class="w-14 h-14 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-2xl mb-2 pointer-events-none">
                    <i class="fa-solid fa-scissors"></i>
                </div>
                <h2 id="split-filename" class="text-base font-bold text-slate-700 pointer-events-none">分割するPDFを選択</h2>
                <p class="text-xs text-slate-400 pointer-events-none">ドラッグ＆ドロップ または クリック</p>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 flex flex-col gap-4">
                <h3 class="font-bold text-slate-700 border-b border-slate-100 pb-2">分割オプション</h3>
                <div class="flex flex-col gap-3">
                    <label class="flex items-center gap-3 p-4 border rounded-2xl cursor-pointer hover:bg-slate-50 transition peer-checked:border-slate-800 peer-checked:bg-slate-50 peer-checked:ring-1 peer-checked:ring-slate-800">
                        <input type="radio" name="split-mode" value="all" class="w-5 h-5 text-slate-800 accent-slate-800" checked onchange="toggleSplitInputs()">
                        <div>
                            <span class="block font-bold text-slate-700">全ページ分割</span>
                            <span class="text-xs text-slate-500">全てのページを1ページごとのPDFファイルにします</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-3 p-4 border rounded-2xl cursor-pointer hover:bg-slate-50 transition peer-checked:border-slate-800 peer-checked:bg-slate-50 peer-checked:ring-1 peer-checked:ring-slate-800">
                        <input type="radio" name="split-mode" value="range" class="w-5 h-5 text-slate-800 accent-slate-800" onchange="toggleSplitInputs()">
                        <div class="flex-1">
                            <span class="block font-bold text-slate-700">指定位置で分割</span>
                            <span class="text-xs text-slate-500">指定したページの後ろでファイルを分割します</span>
                        </div>
                    </label>
                    <div id="split-range-input" class="hidden pl-8 mt-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">分割するページ番号</label>
                        <input type="number" id="split-page-num" min="1" placeholder="例: 2" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-slate-500 focus:outline-none">
                        <p class="text-xs text-slate-400 mt-1">例：「2」と入力すると、1-2ページと3-最後までのページに分割されます。</p>
                    </div>
                </div>
            </div>
            <div class="flex-1"></div>
            <div class="shrink-0 pt-2">
                <button id="btn-exec-split" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-slate-200 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2 text-base" disabled>
                    <i class="fa-solid fa-file-export"></i> 分割を実行
                </button>
            </div>
        </div>

        <!-- =======================
             タブ: 整理 (Organize)
        ======================== -->
        <div id="tab-organize" class="tab-content h-full hidden flex-col gap-4">
             <div id="organize-step-1" class="h-full flex flex-col gap-4">
                <div class="text-center py-2 hidden sm:block shrink-0">
                    <p class="text-slate-500 text-sm">整理・編集したいPDFファイルを1つ選択してください。</p>
                </div>
                <div id="drop-zone-organize" class="flex-1 bg-white border-2 border-dashed border-slate-300 rounded-3xl p-6 text-center transition-all duration-200 cursor-pointer hover:border-blue-400 hover:bg-slate-50 flex flex-col items-center justify-center gap-4">
                    <input type="file" id="file-input-organize" class="hidden" accept="application/pdf">
                    <div class="w-24 h-24 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center text-4xl mb-2 pointer-events-none">
                        <i class="fa-solid fa-table-cells-large"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-700 pointer-events-none">PDFを選択して整理</h2>
                        <p class="text-sm text-slate-400 mt-2 pointer-events-none">ドラッグ＆ドロップ または クリック</p>
                    </div>
                </div>
            </div>

            <div id="organize-step-2" class="h-full hidden flex-col gap-3">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap gap-2 items-center justify-between shrink-0">
                    <div class="flex items-center gap-2">
                        <button onclick="orgRotate(-90)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2" title="左90度回転">
                            <i class="fa-solid fa-rotate-left"></i> <span class="hidden sm:inline">左回転</span>
                        </button>
                        <button onclick="orgRotate(90)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2" title="右90度回転">
                            <i class="fa-solid fa-rotate-right"></i> <span class="hidden sm:inline">右回転</span>
                        </button>
                        <div class="w-px h-6 bg-slate-300 mx-2"></div>
                        <button onclick="orgDelete()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2" title="選択したページを削除">
                            <i class="fa-regular fa-trash-can"></i> <span class="hidden sm:inline">削除</span>
                        </button>
                    </div>
                    <div class="text-xs font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                        <span id="org-selected-count" class="font-bold text-slate-800">0</span> ページ選択中
                    </div>
                </div>

                <div class="flex-1 bg-slate-100 rounded-3xl border-inner border-slate-200 overflow-y-auto p-4">
                    <div id="organize-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- ここにJSでページカードが追加されます -->
                    </div>
                </div>

                <div class="shrink-0 flex gap-3 pt-2">
                    <button onclick="resetOrganize()" class="bg-white border border-slate-300 text-slate-600 font-bold py-4 px-6 rounded-2xl hover:bg-slate-50 transition">
                        キャンセル
                    </button>
                    <button id="btn-exec-organize" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-slate-200 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> 編集したPDFを保存
                    </button>
                </div>
            </div>
        </div>

        <!-- =======================
             タブ: 変換 (Convert) - Updated
        ======================== -->
        <div id="tab-convert" class="tab-content h-full hidden flex-col gap-4">
            <div class="flex items-center justify-center gap-2 bg-slate-100 p-1.5 rounded-2xl shrink-0">
                <button onclick="toggleConvertMode('img2pdf')" id="btn-mode-img2pdf" class="flex-1 py-2.5 px-4 rounded-xl text-sm font-bold shadow-sm bg-white text-slate-800 transition">画像 → PDF</button>
                <button onclick="toggleConvertMode('pdf2img')" id="btn-mode-pdf2img" class="flex-1 py-2.5 px-4 rounded-xl text-sm font-medium text-slate-500 hover:bg-white/50 transition">PDF → 画像</button>
            </div>

            <!-- 画像 → PDF モード -->
            <div id="convert-img2pdf" class="flex-1 flex flex-col gap-4">
                <div class="text-center py-2 hidden sm:block shrink-0">
                    <p class="text-slate-500 text-sm">画像をアップロードし、PDFファイルに変換・結合します。</p>
                </div>
                
                <div id="drop-zone-img2pdf" class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-4 text-center transition-all duration-200 cursor-pointer hover:border-blue-400 hover:bg-slate-50 flex flex-col items-center justify-center gap-2 shrink-0">
                    <input type="file" id="file-input-img2pdf" class="hidden" multiple accept="image/jpeg, image/png">
                    <div class="w-12 h-12 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-xl mb-1 pointer-events-none">
                        <i class="fa-regular fa-image"></i>
                    </div>
                    <h2 class="text-sm font-bold text-slate-700 pointer-events-none">画像を追加 (JPG, PNG)</h2>
                    <p class="text-xs text-slate-400 pointer-events-none">ドラッグ＆ドロップ または クリック</p>
                </div>

                <div class="flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col min-h-0">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-list-ul text-slate-400"></i> 画像一覧
                            <span id="count-img2pdf" class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">0</span>
                        </h3>
                        <button id="clear-img2pdf" class="text-xs text-red-500 hover:text-red-700 font-medium hidden transition hover:bg-red-50 px-2 py-1 rounded">
                            <i class="fa-regular fa-trash-can mr-1"></i>すべて削除
                        </button>
                    </div>
                    <div id="list-img2pdf" class="flex-1 overflow-y-auto p-4 space-y-2">
                         <div id="empty-img2pdf" class="h-full flex flex-col items-center justify-center text-slate-300 py-6">
                            <i class="fa-regular fa-images text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">画像がまだありません</p>
                        </div>
                    </div>
                </div>

                <div class="shrink-0 pt-2">
                    <button id="btn-exec-img2pdf" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-slate-200 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2 text-base" disabled>
                        <i class="fa-solid fa-file-export"></i> PDFに変換してダウンロード
                    </button>
                </div>
            </div>

            <!-- PDF → 画像 モード -->
            <div id="convert-pdf2img" class="flex-1 hidden flex-col gap-4">
                <div class="text-center py-2 hidden sm:block shrink-0">
                    <p class="text-slate-500 text-sm">PDFをアップロードし、全ページを画像として保存します。</p>
                </div>

                <div id="drop-zone-pdf2img" class="flex-1 bg-white border-2 border-dashed border-slate-300 rounded-3xl p-6 text-center transition-all duration-200 cursor-pointer hover:border-blue-400 hover:bg-slate-50 flex flex-col items-center justify-center gap-4">
                    <input type="file" id="file-input-pdf2img" class="hidden" accept="application/pdf">
                    <div class="w-24 h-24 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-4xl mb-2 pointer-events-none">
                        <i class="fa-solid fa-file-pdf"></i>
                    </div>
                    <div>
                        <h2 id="filename-pdf2img" class="text-xl font-bold text-slate-700 pointer-events-none">PDFを選択</h2>
                        <p class="text-sm text-slate-400 mt-2 pointer-events-none">ドラッグ＆ドロップ または クリック</p>
                    </div>
                </div>

                <div class="shrink-0 pt-2">
                    <button id="btn-exec-pdf2img" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-slate-200 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2 text-base" disabled>
                        <i class="fa-regular fa-images"></i> 画像に変換してダウンロード
                    </button>
                </div>
            </div>
        </div>

        <!-- =======================
             タブ: 番号 (Number) - Updated
        ======================== -->
        <div id="tab-number" class="tab-content h-full hidden flex-col gap-4">
            <div class="text-center py-2 hidden sm:block shrink-0">
                <p class="text-slate-500 text-sm">PDFをアップロードし、ページ番号を追記します。</p>
            </div>

            <div id="drop-zone-number" class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-6 text-center transition-all duration-200 cursor-pointer hover:border-blue-400 hover:bg-slate-50 flex flex-col items-center justify-center gap-2 shrink-0">
                <input type="file" id="file-input-number" class="hidden" accept="application/pdf">
                <div class="w-14 h-14 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-2xl mb-2 pointer-events-none">
                    <i class="fa-solid fa-hashtag"></i>
                </div>
                <h2 id="filename-number" class="text-base font-bold text-slate-700 pointer-events-none">PDFを選択</h2>
                <p class="text-xs text-slate-400 pointer-events-none">ドラッグ＆ドロップ または クリック</p>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 flex flex-col gap-6">
                <h3 class="font-bold text-slate-700 border-b border-slate-100 pb-2">設定</h3>
                
                <!-- 書式 -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">書式</label>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50 transition peer-checked:border-slate-800 flex-1">
                            <input type="radio" name="num-format" value="page_only" class="w-5 h-5 text-slate-800 accent-slate-800" checked>
                            <span class="text-sm font-medium text-slate-700">ページ番号のみ (例: 1)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50 transition peer-checked:border-slate-800 flex-1">
                            <input type="radio" name="num-format" value="page_total" class="w-5 h-5 text-slate-800 accent-slate-800">
                            <span class="text-sm font-medium text-slate-700">ページ / 総数 (例: 1 / 10)</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- 位置 -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700">表示位置</label>
                        <div class="relative">
                            <select id="num-position" class="w-full appearance-none border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-slate-500 focus:outline-none bg-white">
                                <option value="bottom-center" selected>中央下</option>
                                <option value="bottom-left">左下</option>
                                <option value="bottom-right">右下</option>
                                <option value="top-center">中央上</option>
                                <option value="top-left">左上</option>
                                <option value="top-right">右上</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 文字サイズ -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700">文字サイズ</label>
                        <input type="number" id="num-size" value="12" min="6" max="72" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-slate-500 focus:outline-none">
                    </div>
                </div>
            </div>

            <div class="flex-1"></div>
            <div class="shrink-0 pt-2">
                <button id="btn-exec-number" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-slate-200 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2 text-base" disabled>
                    <i class="fa-solid fa-file-pen"></i> 番号を追加してダウンロード
                </button>
            </div>
        </div>

    </main>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center max-w-xs w-full mx-4 animate-fade-in">
            <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <h3 class="text-lg font-bold text-slate-800 mb-1">処理中...</h3>
            <p class="text-sm text-slate-500 text-center">しばらくお待ちください。</p>
        </div>
    </div>

    <!-- 通知トースト -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-bold transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-3 pointer-events-none w-max max-w-[90%]">
        <i class="fa-solid fa-check-circle text-green-400 text-lg"></i>
        <span id="toast-message" class="truncate">メッセージ</span>
    </div>

    <script>
        // ==========================================
        // 共通ユーティリティ
        // ==========================================
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = msg;
            const icon = toast.querySelector('i');
            if (isError) {
                icon.className = 'fa-solid fa-circle-exclamation text-red-400 text-lg';
            } else {
                icon.className = 'fa-solid fa-check-circle text-green-400 text-lg';
            }
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        function toggleLoading(show) {
            if(show) loadingOverlay.classList.remove('hidden');
            else loadingOverlay.classList.add('hidden');
        }

        // ==========================================
        // タブ切り替え機能 (セグメンテッドコントロール風)
        // ==========================================
        function switchTab(tabName) {
            // アクティブ時のスタイル: 白背景、青文字、影、太字
            const activeClasses = ['bg-white', 'text-blue-600', 'shadow-sm', 'font-bold'];
            // 非アクティブ時のスタイル: グレー文字、背景なし（ホバーで色が変わる）、中太字
            const inactiveClasses = ['text-slate-500', 'hover:text-slate-700', 'font-medium'];

            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('active', ...activeClasses);
                    btn.classList.remove(...inactiveClasses);
                } else {
                    btn.classList.remove('active', ...activeClasses);
                    btn.classList.add(...inactiveClasses);
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                if(content.id === `tab-${tabName}`) {
                    content.classList.remove('hidden');
                    content.classList.remove('flex');
                    content.style.display = 'flex';
                } else {
                    content.style.display = 'none';
                }
            });
        }

        // ==========================================
        // 機能: 結合 (Merge)
        // ==========================================
        let mergeFiles = []; 
        const mergeDropZone = document.getElementById('drop-zone-merge');
        const mergeFileInput = document.getElementById('file-input-merge');
        const mergeFileListEl = document.getElementById('file-list-merge');
        const mergeEmptyState = document.getElementById('empty-state-merge');
        const mergeFileCount = document.getElementById('file-count-merge');
        const btnExecMerge = document.getElementById('btn-exec-merge');
        const clearBtnMerge = document.getElementById('clear-btn-merge');

        function renderMergeList() {
            mergeFileListEl.innerHTML = '';
            if (mergeFiles.length === 0) {
                mergeFileListEl.appendChild(mergeEmptyState);
                btnExecMerge.disabled = true;
                clearBtnMerge.classList.add('hidden');
                mergeFileCount.textContent = '0';
                return;
            }

            btnExecMerge.disabled = false;
            clearBtnMerge.classList.remove('hidden');
            mergeFileCount.textContent = mergeFiles.length;

            mergeFiles.forEach((item, index) => {
                const li = document.createElement('div');
                li.className = 'animate-fade-in group bg-white border border-slate-200 rounded-2xl p-3 flex items-center gap-3 hover:shadow-md transition-shadow select-none';
                li.innerHTML = `
                    <div class="drag-handle text-slate-300 hover:text-slate-500 cursor-grab px-2 py-2" title="ドラッグして並べ替え">
                        <i class="fa-solid fa-grip-lines"></i>
                    </div>
                    <div class="bg-red-50 text-red-500 w-10 h-10 rounded-xl flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-file-pdf text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-slate-800 font-bold truncate text-sm" title="${item.name}">${item.name}</div>
                        <div class="text-xs text-slate-400 font-medium">${formatSize(item.size)}</div>
                    </div>
                    <button onclick="removeMergeFile('${item.id}')" class="w-8 h-8 rounded-full hover:bg-red-50 text-slate-300 hover:text-red-500 transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                `;
                mergeFileListEl.appendChild(li);
            });

            new Sortable(mergeFileListEl, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    const item = mergeFiles.splice(evt.oldIndex, 1)[0];
                    mergeFiles.splice(evt.newIndex, 0, item);
                    renderMergeList();
                },
            });
        }

        window.removeMergeFile = (id) => {
            mergeFiles = mergeFiles.filter(f => f.id !== id);
            renderMergeList();
        };

        function addMergeFiles(files) {
            let count = 0;
            Array.from(files).forEach(file => {
                if(file.type !== 'application/pdf') {
                    showToast(`${file.name}はPDFではありません`, true);
                    return;
                }
                mergeFiles.push({
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    file: file,
                    name: file.name,
                    size: file.size
                });
                count++;
            });
            if(count > 0) {
                renderMergeList();
                showToast(`${count}個のファイルを追加しました`);
            }
        }

        mergeDropZone.addEventListener('click', () => mergeFileInput.click());
        mergeFileInput.addEventListener('change', (e) => { addMergeFiles(e.target.files); mergeFileInput.value=''; });
        clearBtnMerge.addEventListener('click', () => { if(confirm('全て削除しますか？')){ mergeFiles=[]; renderMergeList(); } });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            mergeDropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        ['dragenter', 'dragover'].forEach(evt => mergeDropZone.classList.add('drag-active'));
        ['dragleave', 'drop'].forEach(evt => mergeDropZone.classList.remove('drag-active'));
        mergeDropZone.addEventListener('drop', (e) => addMergeFiles(e.dataTransfer.files));

        btnExecMerge.addEventListener('click', async () => {
            if (mergeFiles.length === 0) return;
            toggleLoading(true);
            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                for (const fileObj of mergeFiles) {
                    const arrayBuffer = await fileObj.file.arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }
                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                saveAs(blob, `merged-${Date.now()}.pdf`);
                showToast('結合完了！ダウンロードを開始します');
            } catch (error) {
                console.error(error);
                showToast('エラー: ' + error.message, true);
            } finally {
                toggleLoading(false);
            }
        });


        // ==========================================
        // 機能: 分割 (Split)
        // ==========================================
        let splitFile = null;
        const splitDropZone = document.getElementById('drop-zone-split');
        const splitFileInput = document.getElementById('file-input-split');
        const splitFileName = document.getElementById('split-filename');
        const btnExecSplit = document.getElementById('btn-exec-split');
        const splitRangeInput = document.getElementById('split-range-input');

        window.toggleSplitInputs = () => {
            const mode = document.querySelector('input[name="split-mode"]:checked').value;
            if (mode === 'range') {
                splitRangeInput.classList.remove('hidden');
            } else {
                splitRangeInput.classList.add('hidden');
            }
        };

        function setSplitFile(file) {
            if (file.type !== 'application/pdf') {
                showToast('PDFファイルを選択してください', true);
                return;
            }
            splitFile = file;
            splitFileName.textContent = file.name;
            splitFileName.classList.add('text-blue-600');
            btnExecSplit.disabled = false;
            showToast('ファイルを選択しました');
        }

        splitDropZone.addEventListener('click', () => splitFileInput.click());
        splitFileInput.addEventListener('change', (e) => { 
            if(e.target.files[0]) setSplitFile(e.target.files[0]); 
            splitFileInput.value = '';
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            splitDropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        splitDropZone.addEventListener('drop', (e) => {
            if(e.dataTransfer.files[0]) setSplitFile(e.dataTransfer.files[0]);
        });

        btnExecSplit.addEventListener('click', async () => {
            if (!splitFile) return;
            toggleLoading(true);

            try {
                const arrayBuffer = await splitFile.arrayBuffer();
                const srcPdf = await PDFLib.PDFDocument.load(arrayBuffer);
                const totalPages = srcPdf.getPageCount();
                const mode = document.querySelector('input[name="split-mode"]:checked').value;
                const zip = new JSZip();

                if (mode === 'all') {
                    for (let i = 0; i < totalPages; i++) {
                        const newPdf = await PDFLib.PDFDocument.create();
                        const [page] = await newPdf.copyPages(srcPdf, [i]);
                        newPdf.addPage(page);
                        const pdfBytes = await newPdf.save();
                        zip.file(`page-${i + 1}.pdf`, pdfBytes);
                    }
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, "split-pages.zip");
                } else {
                    const splitPointStr = document.getElementById('split-page-num').value;
                    const splitPoint = parseInt(splitPointStr);
                    if (isNaN(splitPoint) || splitPoint < 1 || splitPoint >= totalPages) throw new Error(`有効なページ番号を指定してください`);

                    const pdf1 = await PDFLib.PDFDocument.create();
                    const pages1 = await pdf1.copyPages(srcPdf, Array.from({length: splitPoint}, (_, i) => i));
                    pages1.forEach(p => pdf1.addPage(p));
                    zip.file(`part1_pages-1-${splitPoint}.pdf`, await pdf1.save());

                    const pdf2 = await PDFLib.PDFDocument.create();
                    const pages2 = await pdf2.copyPages(srcPdf, Array.from({length: totalPages - splitPoint}, (_, i) => i + splitPoint));
                    pages2.forEach(p => pdf2.addPage(p));
                    zip.file(`part2_pages-${splitPoint + 1}-${totalPages}.pdf`, await pdf2.save());

                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, "split-files.zip");
                }
                showToast('分割完了！Zipファイルをダウンロードします');
            } catch (error) {
                console.error(error);
                showToast(error.message, true);
            } finally {
                toggleLoading(false);
            }
        });

        // ==========================================
        // 機能: 整理 (Organize)
        // ==========================================
        let organizeFile = null;
        let organizeSortable = null;
        const organizeStep1 = document.getElementById('organize-step-1');
        const organizeStep2 = document.getElementById('organize-step-2');
        const organizeDropZone = document.getElementById('drop-zone-organize');
        const organizeFileInput = document.getElementById('file-input-organize');
        const organizeGrid = document.getElementById('organize-grid');
        const orgSelectedCount = document.getElementById('org-selected-count');
        const btnExecOrganize = document.getElementById('btn-exec-organize');

        async function handleOrganizeFile(file) {
            if (file.type !== 'application/pdf') { showToast('PDFファイルを選択してください', true); return; }
            organizeFile = file;
            toggleLoading(true);
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                const pdf = await loadingTask.promise;
                
                organizeStep1.classList.add('hidden');
                organizeStep2.classList.remove('hidden');
                organizeStep2.style.display = 'flex';
                organizeGrid.innerHTML = '';
                orgSelectedCount.textContent = '0';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    await renderPageThumbnail(page, i);
                }

                if(organizeSortable) organizeSortable.destroy();
                organizeSortable = new Sortable(organizeGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    multiDrag: true,
                    selectedClass: 'selected',
                });
                showToast('ページを読み込みました');
            } catch (error) {
                console.error(error);
                showToast('読み込みエラー: ' + error.message, true);
                resetOrganize();
            } finally {
                toggleLoading(false);
            }
        }

        async function renderPageThumbnail(page, pageNum) {
            const scale = 0.5;
            const viewport = page.getViewport({scale: scale});
            const card = document.createElement('div');
            card.className = 'page-card bg-white p-2 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition relative flex flex-col gap-2 select-none';
            card.setAttribute('data-page-index', pageNum - 1);
            card.setAttribute('data-rotation', '0');
            card.addEventListener('click', (e) => { card.classList.toggle('selected'); updateSelectedCount(); });

            const canvasWrapper = document.createElement('div');
            canvasWrapper.className = 'relative w-full aspect-[1/1.414] bg-slate-50 overflow-hidden flex items-center justify-center rounded-lg border border-slate-100';
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.className = 'page-preview-canvas max-w-full max-h-full object-contain';
            const badge = document.createElement('div');
            badge.className = 'absolute bottom-1 right-1 bg-black/60 text-white text-xs font-bold px-2 py-0.5 rounded-full';
            badge.textContent = pageNum;

            canvasWrapper.appendChild(canvas);
            canvasWrapper.appendChild(badge);
            card.appendChild(canvasWrapper);
            organizeGrid.appendChild(card);
            await page.render({canvasContext: context, viewport: viewport}).promise;
        }

        function updateSelectedCount() {
            orgSelectedCount.textContent = document.querySelectorAll('.page-card.selected').length;
        }

        window.orgRotate = (deg) => {
            const selected = document.querySelectorAll('.page-card.selected');
            if(selected.length === 0) { showToast('ページを選択してください', true); return; }
            selected.forEach(card => {
                let currentRot = parseInt(card.getAttribute('data-rotation') || '0');
                let newRot = (currentRot + deg) % 360;
                if(newRot < 0) newRot += 360;
                card.setAttribute('data-rotation', newRot);
                const canvas = card.querySelector('canvas');
                if (newRot % 180 !== 0) {
                     const scale = Math.min(canvas.parentElement.offsetWidth / canvas.height, canvas.parentElement.offsetHeight / canvas.width);
                     canvas.style.transform = `rotate(${newRot}deg) scale(${scale * 0.8})`; 
                } else {
                    canvas.style.transform = `rotate(${newRot}deg)`;
                }
            });
        };

        window.orgDelete = () => {
            const selected = document.querySelectorAll('.page-card.selected');
            if(selected.length === 0) return;
            if(!confirm(`${selected.length}ページを削除しますか？`)) return;
            selected.forEach(card => card.remove());
            updateSelectedCount();
        };

        window.resetOrganize = () => {
            organizeFile = null;
            organizeGrid.innerHTML = '';
            organizeStep2.classList.add('hidden');
            organizeStep1.classList.remove('hidden');
            organizeFileInput.value = '';
        };

        organizeDropZone.addEventListener('click', () => organizeFileInput.click());
        organizeFileInput.addEventListener('change', (e) => { if(e.target.files[0]) handleOrganizeFile(e.target.files[0]); });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            organizeDropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        organizeDropZone.addEventListener('drop', (e) => { if(e.dataTransfer.files[0]) handleOrganizeFile(e.dataTransfer.files[0]); });

        btnExecOrganize.addEventListener('click', async () => {
            const cards = document.querySelectorAll('.page-card');
            if(cards.length === 0) { showToast('ページがありません', true); return; }
            toggleLoading(true);
            try {
                const arrayBuffer = await organizeFile.arrayBuffer();
                const srcPdf = await PDFLib.PDFDocument.load(arrayBuffer);
                const newPdf = await PDFLib.PDFDocument.create();

                for (const card of cards) {
                    const originalIndex = parseInt(card.getAttribute('data-page-index'));
                    const addedRotation = parseInt(card.getAttribute('data-rotation') || '0');
                    const [copiedPage] = await newPdf.copyPages(srcPdf, [originalIndex]);
                    const currentRotation = copiedPage.getRotation().angle;
                    copiedPage.setRotation(PDFLib.degrees(currentRotation + addedRotation));
                    newPdf.addPage(copiedPage);
                }
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                saveAs(blob, `organized-${organizeFile.name}`);
                showToast('保存しました！');
            } catch (error) {
                console.error(error);
                showToast('保存エラー: ' + error.message, true);
            } finally {
                toggleLoading(false);
            }
        });

        // ==========================================
        // 機能: 変換 (Convert)
        // ==========================================
        let imgFiles = [];
        let pdf2imgFile = null;
        
        window.toggleConvertMode = (mode) => {
            document.getElementById('convert-img2pdf').classList.toggle('hidden', mode !== 'img2pdf');
            document.getElementById('convert-img2pdf').style.display = mode === 'img2pdf' ? 'flex' : 'none';
            document.getElementById('convert-pdf2img').classList.toggle('hidden', mode !== 'pdf2img');
            document.getElementById('convert-pdf2img').style.display = mode === 'pdf2img' ? 'flex' : 'none';

            const btnImg = document.getElementById('btn-mode-img2pdf');
            const btnPdf = document.getElementById('btn-mode-pdf2img');
            if (mode === 'img2pdf') {
                btnImg.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                btnImg.classList.remove('text-slate-500', 'hover:bg-white/50');
                btnPdf.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btnPdf.classList.add('text-slate-500', 'hover:bg-white/50');
            } else {
                btnPdf.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                btnPdf.classList.remove('text-slate-500', 'hover:bg-white/50');
                btnImg.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btnImg.classList.add('text-slate-500', 'hover:bg-white/50');
            }
        };

        // --- Img to PDF ---
        const dropZoneImg2Pdf = document.getElementById('drop-zone-img2pdf');
        const fileInputImg2Pdf = document.getElementById('file-input-img2pdf');
        const listImg2Pdf = document.getElementById('list-img2pdf');
        const emptyImg2Pdf = document.getElementById('empty-img2pdf');
        const countImg2Pdf = document.getElementById('count-img2pdf');
        const clearImg2Pdf = document.getElementById('clear-img2pdf');
        const btnExecImg2Pdf = document.getElementById('btn-exec-img2pdf');

        function renderImgList() {
            listImg2Pdf.innerHTML = '';
            if (imgFiles.length === 0) {
                listImg2Pdf.appendChild(emptyImg2Pdf);
                btnExecImg2Pdf.disabled = true;
                clearImg2Pdf.classList.add('hidden');
                countImg2Pdf.textContent = '0';
                return;
            }
            btnExecImg2Pdf.disabled = false;
            clearImg2Pdf.classList.remove('hidden');
            countImg2Pdf.textContent = imgFiles.length;

            imgFiles.forEach((item, index) => {
                const li = document.createElement('div');
                li.className = 'bg-white border border-slate-200 rounded-2xl p-3 flex items-center gap-3 select-none';
                li.innerHTML = `
                    <div class="drag-handle-img text-slate-300 hover:text-slate-500 cursor-grab px-2 py-2"><i class="fa-solid fa-grip-lines"></i></div>
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center shrink-0 overflow-hidden">
                        <img src="${URL.createObjectURL(item.file)}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0 text-sm font-bold truncate text-slate-700">${item.name}</div>
                    <button onclick="removeImgFile('${item.id}')" class="w-8 h-8 rounded-full hover:bg-red-50 text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
                `;
                listImg2Pdf.appendChild(li);
            });

            new Sortable(listImg2Pdf, {
                animation: 150,
                handle: '.drag-handle-img',
                onEnd: function (evt) {
                    const item = imgFiles.splice(evt.oldIndex, 1)[0];
                    imgFiles.splice(evt.newIndex, 0, item);
                    renderImgList();
                }
            });
        }

        window.removeImgFile = (id) => { imgFiles = imgFiles.filter(f => f.id !== id); renderImgList(); };

        dropZoneImg2Pdf.addEventListener('click', () => fileInputImg2Pdf.click());
        fileInputImg2Pdf.addEventListener('change', (e) => {
             Array.from(e.target.files).forEach(f => {
                if(f.type.startsWith('image/')) imgFiles.push({id: Date.now()+Math.random(), file: f, name: f.name});
             });
             renderImgList();
             fileInputImg2Pdf.value = '';
        });

        clearImg2Pdf.addEventListener('click', () => { imgFiles = []; renderImgList(); });

        btnExecImg2Pdf.addEventListener('click', async () => {
            if (imgFiles.length === 0) return;
            toggleLoading(true);
            try {
                const pdfDoc = await PDFLib.PDFDocument.create();
                for (const imgObj of imgFiles) {
                    const imgBytes = await imgObj.file.arrayBuffer();
                    let image;
                    if (imgObj.file.type === 'image/jpeg') image = await pdfDoc.embedJpg(imgBytes);
                    else if (imgObj.file.type === 'image/png') image = await pdfDoc.embedPng(imgBytes);
                    else continue;

                    const page = pdfDoc.addPage([image.width, image.height]);
                    page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                }
                const pdfBytes = await pdfDoc.save();
                saveAs(new Blob([pdfBytes], { type: 'application/pdf' }), `images-converted.pdf`);
                showToast('変換完了！');
            } catch (e) {
                console.error(e);
                showToast('エラー: ' + e.message, true);
            } finally {
                toggleLoading(false);
            }
        });

        // --- PDF to Img ---
        const dropZonePdf2Img = document.getElementById('drop-zone-pdf2img');
        const fileInputPdf2Img = document.getElementById('file-input-pdf2img');
        const filenamePdf2Img = document.getElementById('filename-pdf2img');
        const btnExecPdf2Img = document.getElementById('btn-exec-pdf2img');

        function setPdf2ImgFile(file) {
            if(file.type !== 'application/pdf') { showToast('PDFを選択してください', true); return; }
            pdf2imgFile = file;
            filenamePdf2Img.textContent = file.name;
            filenamePdf2Img.classList.add('text-blue-600');
            btnExecPdf2Img.disabled = false;
        }

        dropZonePdf2Img.addEventListener('click', () => fileInputPdf2Img.click());
        fileInputPdf2Img.addEventListener('change', (e) => { if(e.target.files[0]) setPdf2ImgFile(e.target.files[0]); });

        btnExecPdf2Img.addEventListener('click', async () => {
            if(!pdf2imgFile) return;
            toggleLoading(true);
            try {
                const arrayBuffer = await pdf2imgFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const zip = new JSZip();

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 2.0}); // 高画質
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;
                    
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
                    zip.file(`page-${i}.jpg`, blob);
                }
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "pdf-images.zip");
                showToast('変換完了！ZIPをダウンロードします');
            } catch (e) {
                console.error(e);
                showToast('エラー: ' + e.message, true);
            } finally {
                toggleLoading(false);
            }
        });


        // ==========================================
        // 機能: 番号 (Number)
        // ==========================================
        let numberFile = null;
        const dropZoneNumber = document.getElementById('drop-zone-number');
        const fileInputNumber = document.getElementById('file-input-number');
        const filenameNumber = document.getElementById('filename-number');
        const btnExecNumber = document.getElementById('btn-exec-number');

        function setNumberFile(file) {
            if(file.type !== 'application/pdf') { showToast('PDFを選択してください', true); return; }
            numberFile = file;
            filenameNumber.textContent = file.name;
            filenameNumber.classList.add('text-blue-600');
            btnExecNumber.disabled = false;
        }

        dropZoneNumber.addEventListener('click', () => fileInputNumber.click());
        fileInputNumber.addEventListener('change', (e) => { if(e.target.files[0]) setNumberFile(e.target.files[0]); });

        btnExecNumber.addEventListener('click', async () => {
            if(!numberFile) return;
            toggleLoading(true);
            try {
                const arrayBuffer = await numberFile.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const totalPages = pdfDoc.getPageCount();
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                const fontSize = parseInt(document.getElementById('num-size').value);
                const position = document.getElementById('num-position').value;
                const format = document.querySelector('input[name="num-format"]:checked').value;

                const pages = pdfDoc.getPages();
                pages.forEach((page, idx) => {
                    const { width, height } = page.getSize();
                    const num = idx + 1;
                    const text = format === 'page_total' ? `${num} / ${totalPages}` : `${num}`;
                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                    
                    let x, y;
                    const margin = 20;

                    // Y座標
                    if (position.startsWith('top')) y = height - margin - fontSize;
                    else y = margin;

                    // X座標
                    if (position.includes('left')) x = margin;
                    else if (position.includes('right')) x = width - margin - textWidth;
                    else x = (width - textWidth) / 2;

                    page.drawText(text, { x, y, size: fontSize, font: font, color: PDFLib.rgb(0, 0, 0) });
                });

                const pdfBytes = await pdfDoc.save();
                saveAs(new Blob([pdfBytes], { type: 'application/pdf' }), `numbered-${numberFile.name}`);
                showToast('番号追加完了！');
            } catch (e) {
                console.error(e);
                showToast('エラー: ' + e.message, true);
            } finally {
                toggleLoading(false);
            }
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('merge');
        });

    </script>
</body>
</html>
