<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools - PDF編集ツール</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF-Lib & PDF.js -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <!-- Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; }
        
        /* 窪みデザインのメニュー */
        .menu-container { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        
        /* 有効時のボタンアニメーション */
        @keyframes pulse-indigo {
            0%, 100% { box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 15px 25px -5px rgba(99, 102, 241, 0.5); }
        }
        .btn-enabled { animation: pulse-indigo 2s infinite; }

        /* カスタムスライダー */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 22px; width: 22px; border-radius: 50%;
            background: #ffffff; border: 3px solid #6366f1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer;
            margin-top: -8px; transition: transform 0.1s ease;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }

        /* スクロールのフェード表示 */
        .scroll-gradient {
            position: relative;
        }
        .scroll-gradient::after {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 30px;
            background: linear-gradient(to right, transparent, white); pointer-events: none;
        }

        .tab-btn.active { transform: translateY(-1px); }
        
        /* トーストアニメーション */
        .toast-show { transform: translate(-50%, 0) !important; opacity: 1 !important; }
    </style>
</head>
<body class="text-slate-700 min-h-screen flex flex-col">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm z-20 flex-shrink-0">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3 group">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg group-hover:rotate-12 transition-transform">
                    <i class="fa-solid fa-file-pdf text-xl"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">PDF Tools</h1>
            </div>
            <button onclick="location.reload()" class="text-xs font-bold text-slate-400 hover:text-indigo-600 transition bg-slate-50 px-3 py-2 rounded hover:bg-indigo-50 border border-transparent hover:border-indigo-100 uppercase tracking-widest">
                <i class="fa-solid fa-rotate-right mr-1"></i> Reset
            </button>
        </div>
        
        <!-- メニュー (窪みデザイン) -->
        <div class="px-4 pb-6 bg-white scroll-gradient">
            <div class="max-w-max mx-auto bg-slate-100 p-1 rounded-xl flex overflow-x-auto no-scrollbar menu-container gap-1">
                <button onclick="switchTab('merge')" class="tab-btn active px-5 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 whitespace-nowrap bg-white text-indigo-600 shadow-sm border border-slate-200/50" data-tab="merge">
                    <i class="fa-solid fa-layer-group"></i> 結合
                </button>
                <button onclick="switchTab('split')" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-indigo-500" data-tab="split">
                    <i class="fa-solid fa-scissors"></i> 分割
                </button>
                <button onclick="switchTab('organize')" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-indigo-500" data-tab="organize">
                    <i class="fa-solid fa-table-cells-large"></i> 整理
                </button>
                <button onclick="switchTab('convert')" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-indigo-500" data-tab="convert">
                    <i class="fa-solid fa-right-left"></i> 変換
                </button>
                <button onclick="switchTab('number')" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap text-slate-500 hover:text-indigo-500" data-tab="number">
                    <i class="fa-solid fa-hashtag"></i> 番号
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="flex-1 w-full max-w-4xl mx-auto p-4">
        
        <!-- Tab: Merge -->
        <div id="tab-merge" class="tab-content flex flex-col gap-4 pb-8">
            <p class="text-center text-slate-500 text-sm py-2">複数のPDFを1つに結合します</p>
            <div id="drop-zone-merge" class="min-h-[220px] bg-white border-2 border-dashed border-slate-200 rounded-xl p-8 text-center transition-all hover:border-indigo-400 hover:bg-indigo-50/30 flex flex-col items-center justify-center cursor-pointer group">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-plus"></i>
                </div>
                <h2 class="text-lg font-bold text-slate-700">結合するPDFをドラッグ＆ドロップ</h2>
                <p class="text-sm text-slate-400 mt-1">またはクリックしてファイルを選択</p>
                <input type="file" id="file-input-merge" class="hidden" multiple accept="application/pdf">
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col min-h-[160px]">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-xl">
                    <span class="text-sm font-bold text-slate-600"><i class="fa-solid fa-list mr-2"></i>待機リスト (<span id="file-count-merge">0</span>)</span>
                    <button id="clear-btn-merge" class="text-xs font-bold text-red-400 hover:text-red-600 transition hidden">すべて削除</button>
                </div>
                <div id="file-list-merge" class="p-4 space-y-2">
                    <div id="empty-state-merge" class="py-10 text-center text-slate-300">
                        <i class="fa-regular fa-folder-open text-4xl mb-2 block"></i>
                        <span class="text-sm">ファイルが選択されていません</span>
                    </div>
                </div>
            </div>
            <button id="btn-exec-merge" class="w-full py-4 rounded-lg text-white font-bold text-lg transition-all flex items-center justify-center gap-3 bg-slate-300 cursor-not-allowed" disabled>
                <i class="fa-solid fa-download"></i> 結合してダウンロード
            </button>
        </div>

        <!-- Tab: Split -->
        <div id="tab-split" class="tab-content hidden flex-col gap-4 pb-8">
            <p class="text-center text-slate-500 text-sm py-2">PDFファイルを分割します</p>
            <div id="drop-zone-split" class="min-h-[220px] bg-white border-2 border-dashed border-slate-200 rounded-xl p-8 text-center transition-all hover:border-indigo-400 hover:bg-indigo-50/30 flex flex-col items-center justify-center cursor-pointer">
                <input type="file" id="file-input-split" class="hidden" accept="application/pdf">
                <!-- 初期表示 -->
                <div id="split-default-content">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl mb-4 mx-auto group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-700">分割するPDFをドラッグ＆ドロップ</h2>
                    <p class="text-sm text-slate-400 mt-1">またはクリックして選択 (1ファイルのみ)</p>
                </div>
                <!-- 選択後表示 (JSで挿入) -->
                <div id="split-selected-content" class="hidden w-full"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                <div class="flex gap-4">
                    <label class="flex-1 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-slate-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50/50">
                        <input type="radio" name="split-mode" value="all" class="hidden" checked onchange="toggleSplitInputs()">
                        <div class="text-center">
                            <div class="font-bold text-slate-700 mb-1">全ページ分割</div>
                            <div class="text-[10px] text-slate-400 leading-tight">全ページを単一PDF化</div>
                        </div>
                    </label>
                    <label class="flex-1 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-slate-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50/50">
                        <input type="radio" name="split-mode" value="range" class="hidden" onchange="toggleSplitInputs()">
                        <div class="text-center">
                            <div class="font-bold text-slate-700 mb-1">位置指定分割</div>
                            <div class="text-[10px] text-slate-400 leading-tight">スライダーで区切る</div>
                        </div>
                    </label>
                </div>

                <div id="split-range-input" class="hidden animate-fade-in">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <span class="text-[10px] font-bold text-indigo-500 uppercase tracking-tighter">Split Position</span>
                            <div class="text-2xl font-black text-slate-800">Page <span id="slider-current-val">1</span></div>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Total</span>
                            <div class="text-sm font-bold text-slate-500"><span id="total-pages-display">0</span> Pages</div>
                        </div>
                    </div>
                    
                    <div class="relative px-2 mb-10">
                        <input type="range" id="split-slider" min="1" max="1" value="1" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                        <div id="slider-value-popover" class="absolute -top-8 left-0 transform -translate-x-1/2 bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded opacity-0 transition-all pointer-events-none">p.<span id="slider-current-val-pop">1</span></div>
                    </div>

                    <div class="flex gap-1 items-stretch h-16 w-full opacity-80">
                        <div id="preview-part1" class="bg-indigo-600 rounded-l-lg flex items-center justify-center text-white text-[10px] font-bold border-r border-white/20 transition-all">1-<span id="preview-p1-end">?</span></div>
                        <div id="preview-part2" class="bg-slate-400 rounded-r-lg flex items-center justify-center text-white text-[10px] font-bold transition-all"><span id="preview-p2-start">?</span>-END</div>
                    </div>
                </div>
            </div>
            
            <button id="btn-exec-split" class="w-full py-4 rounded-lg text-white font-bold text-lg transition-all flex items-center justify-center gap-3 bg-slate-300 cursor-not-allowed" disabled>
                <i class="fa-solid fa-download"></i> 分割してダウンロード
            </button>
        </div>

        <!-- Tab: Organize -->
        <div id="tab-organize" class="tab-content hidden flex-col gap-4 pb-8">
             <div id="organize-step-1" class="flex flex-col gap-4">
                <p class="text-center text-slate-500 text-sm py-2">ページの並び替え・削除・回転をします</p>
                <div id="drop-zone-organize" class="min-h-[220px] bg-white border-2 border-dashed border-slate-200 rounded-xl p-8 text-center transition-all hover:border-indigo-400 hover:bg-indigo-50/30 flex flex-col items-center justify-center cursor-pointer">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl mb-4 italic">
                        <i class="fa-solid fa-table-cells-large"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-700">整理するPDFをドラッグ＆ドロップ</h2>
                    <p class="text-sm text-slate-400 mt-1">またはクリックして選択</p>
                    <input type="file" id="file-input-organize" class="hidden" accept="application/pdf">
                </div>
            </div>

            <div id="organize-step-2" class="hidden flex-col gap-4">
                <div class="bg-white/80 backdrop-blur p-3 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between sticky top-0 z-10">
                    <div class="flex items-center gap-1.5">
                        <button onclick="orgRotate(-90)" class="p-2.5 bg-slate-100 hover:bg-indigo-100 hover:text-indigo-600 rounded-lg text-slate-600 transition shadow-sm" title="左回転"><i class="fa-solid fa-rotate-left"></i></button>
                        <button onclick="orgRotate(90)" class="p-2.5 bg-slate-100 hover:bg-indigo-100 hover:text-indigo-600 rounded-lg text-slate-600 transition shadow-sm" title="右回転"><i class="fa-solid fa-rotate-right"></i></button>
                        <div class="w-px h-6 bg-slate-200 mx-1"></div>
                        <button onclick="orgDelete()" class="p-2.5 bg-red-50 hover:bg-red-500 hover:text-white rounded-lg text-red-500 transition shadow-sm" title="削除"><i class="fa-regular fa-trash-can"></i></button>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-3 py-1.5 rounded-full"><span id="org-selected-count" class="text-indigo-600">0</span> Selected</span>
                </div>

                <div id="organize-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 bg-slate-100/50 p-4 rounded-xl border border-slate-200">
                    <!-- JS Content -->
                </div>

                <div class="flex gap-3">
                    <button onclick="resetOrganize()" class="flex-1 py-4 bg-white border border-slate-200 text-slate-500 font-bold rounded-lg hover:bg-slate-50 transition">キャンセル</button>
                    <button id="btn-exec-organize" class="flex-[2] py-4 bg-indigo-600 text-white font-bold rounded-lg shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
                        <i class="fa-solid fa-download mr-2"></i> 整理してダウンロード
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Convert -->
        <div id="tab-convert" class="tab-content hidden flex-col gap-4 pb-8">
            <div class="flex p-1 bg-slate-100 rounded-lg">
                <button onclick="toggleConvertMode('img2pdf')" id="btn-mode-img2pdf" class="flex-1 py-2 text-sm rounded-md transition bg-indigo-100 text-indigo-700 font-bold shadow-sm border border-indigo-200">画像 → PDF</button>
                <button onclick="toggleConvertMode('pdf2img')" id="btn-mode-pdf2img" class="flex-1 py-2 text-sm rounded-md transition text-slate-500 font-medium hover:bg-white/50">PDF → 画像</button>
            </div>
            
            <!-- Img2Pdf (Multiple Files) -->
            <div id="convert-img2pdf" class="flex flex-col gap-4">
                <p class="text-center text-slate-500 text-sm py-2">画像をPDFに変換します</p>
                <div id="drop-zone-img2pdf" class="min-h-[220px] bg-white border-2 border-dashed border-slate-200 rounded-xl p-6 text-center transition-all hover:border-indigo-400 hover:bg-indigo-50/30 flex flex-col items-center justify-center cursor-pointer">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-700">画像をドラッグ＆ドロップ</h2>
                    <p class="text-sm text-slate-400 mt-1">またはクリックして選択 (JPG/PNG)</p>
                    <input type="file" id="file-input-img2pdf" class="hidden" multiple accept="image/jpeg, image/png">
                </div>
                <div class="bg-white rounded-xl border border-slate-200 min-h-[160px] flex flex-col">
                    <div class="p-3 border-b border-slate-50 flex justify-between items-center rounded-t-xl bg-slate-50/50">
                        <span class="text-sm font-bold text-slate-600"><i class="fa-solid fa-list mr-2"></i>画像リスト (<span id="count-img2pdf">0</span>)</span>
                        <button id="clear-img2pdf" class="text-xs font-bold text-red-400 hover:text-red-600 transition hidden">すべて削除</button>
                    </div>
                    <div id="list-img2pdf" class="p-4 space-y-2">
                        <div id="empty-img2pdf" class="py-10 text-center text-slate-300">
                            <i class="fa-regular fa-images text-4xl mb-2 block"></i>
                            <span class="text-sm">画像がまだありません</span>
                        </div>
                    </div>
                </div>
                <div class="pt-4">
                    <button id="btn-exec-img2pdf" class="w-full py-4 rounded-lg text-white font-bold bg-slate-300 cursor-not-allowed transition-all" disabled><i class="fa-solid fa-download mr-2"></i> PDFに変換してダウンロード</button>
                </div>
            </div>

            <!-- Pdf2Img (Single File) -->
            <div id="convert-pdf2img" class="hidden flex-col gap-4">
                <p class="text-center text-slate-500 text-sm py-2">PDFを画像に変換します</p>
                <div id="drop-zone-pdf2img" class="min-h-[220px] bg-white border-2 border-dashed border-slate-200 rounded-xl p-8 text-center transition-all hover:border-indigo-400 hover:bg-indigo-50/30 flex flex-col items-center justify-center cursor-pointer">
                    <input type="file" id="file-input-pdf2img" class="hidden" accept="application/pdf">
                    <!-- 初期表示 -->
                    <div id="pdf2img-default-content">
                        <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl mb-4 mx-auto group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                        <h2 class="text-lg font-bold text-slate-700">変換するPDFをドラッグ＆ドロップ</h2>
                        <p class="text-sm text-slate-400 mt-1">またはクリックして選択</p>
                    </div>
                    <!-- 選択後表示 -->
                    <div id="pdf2img-selected-content" class="hidden w-full"></div>
                </div>
                <div class="pt-4">
                    <button id="btn-exec-pdf2img" class="w-full py-4 rounded-lg text-white font-bold bg-slate-300 cursor-not-allowed transition-all" disabled><i class="fa-solid fa-download mr-2"></i> 画像に変換してダウンロード</button>
                </div>
            </div>
        </div>

        <!-- Tab: Number (Single File) -->
        <div id="tab-number" class="tab-content hidden flex-col gap-4 pb-8">
            <p class="text-center text-slate-500 text-sm py-2">ページ番号を追加します</p>
            <div id="drop-zone-number" class="min-h-[220px] bg-white border-2 border-dashed border-slate-200 rounded-xl p-8 text-center transition-all hover:border-indigo-400 hover:bg-indigo-50/30 flex flex-col items-center justify-center cursor-pointer">
                <input type="file" id="file-input-number" class="hidden" accept="application/pdf">
                <!-- 初期表示 -->
                <div id="number-default-content">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl mb-4 mx-auto group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-700">番号を追加するPDFをドラッグ＆ドロップ</h2>
                    <p class="text-sm text-slate-400 mt-1">またはクリックして選択</p>
                </div>
                <!-- 選択後表示 -->
                <div id="number-selected-content" class="hidden w-full"></div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">位置</label>
                        <div class="relative">
                            <select id="num-position" class="w-full appearance-none border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:border-indigo-500 transition bg-white text-slate-700">
                                <option value="bottom-center">中央下</option>
                                <option value="bottom-left">左下</option>
                                <option value="bottom-right">右下</option>
                                <option value="top-center">中央上</option>
                                <option value="top-left">左上</option>
                                <option value="top-right">右上</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">サイズ</label>
                        <input type="number" id="num-size" value="12" class="w-full border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:border-indigo-500 text-slate-700">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">書式</label>
                    <div class="flex gap-4">
                        <label class="flex-1 flex items-center justify-center p-3 border rounded-lg cursor-pointer transition hover:bg-slate-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50/50 has-[:checked]:text-indigo-700 border-slate-200">
                            <input type="radio" name="num-format" value="page_only" class="hidden" checked><span class="text-xs font-bold">1, 2, 3...</span>
                        </label>
                        <label class="flex-1 flex items-center justify-center p-3 border rounded-lg cursor-pointer transition hover:bg-slate-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50/50 has-[:checked]:text-indigo-700 border-slate-200">
                            <input type="radio" name="num-format" value="page_total" class="hidden"><span class="text-xs font-bold">1 / 10...</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="pt-4">
                <button id="btn-exec-number" class="w-full py-4 rounded-lg text-white font-bold bg-slate-300 cursor-not-allowed transition-all" disabled><i class="fa-solid fa-download mr-2"></i> 番号を追加してダウンロード</button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-50 border-t border-slate-200 py-4 flex-shrink-0 z-10 w-full">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-xs font-medium tracking-wide">&copy; 2026 Yuichiro Yoshida.</p>
        </div>
    </footer>

    <!-- Overlay & Notification -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
            <p class="font-bold text-slate-800">Processing...</p>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold transition-all duration-500 opacity-0 translate-y-12 z-50 flex items-center gap-3 pointer-events-none">
        <i class="fa-solid fa-check-circle text-emerald-400 text-lg"></i>
        <span id="toast-message">Message</span>
    </div>

    <script>
        // --- Core Utilities ---
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            const icon = toast.querySelector('i');
            icon.className = isError ? 'fa-solid fa-circle-exclamation text-red-400 text-lg' : 'fa-solid fa-check-circle text-emerald-400 text-lg';
            toast.classList.add('toast-show');
            setTimeout(() => toast.classList.remove('toast-show'), 3000);
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function updateBtnState(btnId, enabled) {
            const btn = document.getElementById(btnId);
            if(enabled) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'btn-enabled');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-slate-300', 'cursor-not-allowed');
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'btn-enabled');
            }
        }

        // --- Helper for Single File Selection UI ---
        function updateSingleFileUI(type, file, resetCallbackName) {
            const defaultContent = document.getElementById(`${type}-default-content`);
            const selectedContent = document.getElementById(`${type}-selected-content`);
            const zone = document.getElementById(`drop-zone-${type}`);
            
            if (file) {
                defaultContent.classList.add('hidden');
                selectedContent.classList.remove('hidden');
                zone.classList.add('bg-indigo-50/50', 'border-indigo-300');
                
                selectedContent.innerHTML = `
                    <div class="flex flex-col items-center animate-fade-in w-full">
                        <div class="w-16 h-16 bg-white border border-indigo-100 rounded-2xl flex items-center justify-center text-3xl mb-3 shadow-sm text-indigo-500">
                            <i class="fa-solid fa-file-pdf"></i>
                        </div>
                        <div class="text-sm font-bold text-slate-700 mb-1 max-w-[80%] truncate">${file.name}</div>
                        <div class="text-xs text-slate-400 mb-4 font-mono">${formatSize(file.size)}</div>
                        <button onclick="${resetCallbackName}()" class="px-4 py-2 bg-white border border-red-200 text-red-500 rounded-full text-xs font-bold hover:bg-red-50 transition shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-trash-can"></i> 削除する
                        </button>
                    </div>
                `;
            } else {
                defaultContent.classList.remove('hidden');
                selectedContent.classList.add('hidden');
                selectedContent.innerHTML = '';
                zone.classList.remove('bg-indigo-50/50', 'border-indigo-300');
            }
        }

        // --- Tab Management ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('text-indigo-600', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('font-bold', isActive);
                btn.classList.toggle('border', isActive);
                btn.classList.toggle('text-slate-500', !isActive);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `tab-${tabName}`);
                if(content.id === `tab-${tabName}`) content.classList.add('flex');
            });
        }

        // --- Merge Logic ---
        let mergeFiles = [];
        const mDrop = document.getElementById('drop-zone-merge');
        const mInput = document.getElementById('file-input-merge');
        const mList = document.getElementById('file-list-merge');

        function renderMerge() {
            mList.innerHTML = '';
            if(mergeFiles.length === 0) {
                mList.appendChild(document.getElementById('empty-state-merge'));
                updateBtnState('btn-exec-merge', false);
                document.getElementById('clear-btn-merge').classList.add('hidden');
            } else {
                updateBtnState('btn-exec-merge', true);
                document.getElementById('clear-btn-merge').classList.remove('hidden');
                mergeFiles.forEach((f, i) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 bg-white p-3 border border-slate-100 rounded-lg hover:shadow-md transition-shadow select-none animate-fade-in';
                    el.innerHTML = `
                        <div class="drag-handle cursor-grab text-slate-300 px-1"><i class="fa-solid fa-grip-lines"></i></div>
                        <div class="flex-1 truncate text-sm font-medium text-slate-700">${f.name}</div>
                        <button onclick="mergeFiles.splice(${i},1);renderMerge();" class="text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
                    `;
                    mList.appendChild(el);
                });
                new Sortable(mList, { handle:'.drag-handle', animation:150, onEnd:(evt)=>{
                    const item = mergeFiles.splice(evt.oldIndex, 1)[0];
                    mergeFiles.splice(evt.newIndex, 0, item);
                    renderMerge();
                }});
            }
            document.getElementById('file-count-merge').textContent = mergeFiles.length;
        }

        mDrop.onclick = (e) => {
            if (e.target.closest('button')) return; // 削除ボタン等なら何もしない
            mInput.click();
        };
        mInput.onchange = (e) => {
            Array.from(e.target.files).forEach(f => {
                if(f.type === 'application/pdf') mergeFiles.push({id:Math.random(), name:f.name, file:f});
            });
            renderMerge();
            mInput.value = '';
        };
        document.getElementById('clear-btn-merge').onclick = () => { mergeFiles = []; renderMerge(); showToast('リストをクリアしました'); };
        
        document.getElementById('btn-exec-merge').onclick = async () => {
            toggleLoading(true);
            try {
                const merged = await PDFLib.PDFDocument.create();
                for (const f of mergeFiles) {
                    const doc = await PDFLib.PDFDocument.load(await f.file.arrayBuffer());
                    const pages = await merged.copyPages(doc, doc.getPageIndices());
                    pages.forEach(p => merged.addPage(p));
                }
                saveAs(new Blob([await merged.save()], {type:'application/pdf'}), `combined-${Date.now()}.pdf`);
                showToast('結合完了！');
            } catch(e) { showToast('エラーが発生しました', true); } finally { toggleLoading(false); }
        };

        // --- Split Logic ---
        let splitFile = null; let splitTotal = 0;
        const sDrop = document.getElementById('drop-zone-split');
        const sInput = document.getElementById('file-input-split');
        const sSlider = document.getElementById('split-slider');

        function updateSplitUI() {
            const val = parseInt(sSlider.value);
            document.getElementById('slider-current-val').textContent = val;
            document.getElementById('slider-current-val-pop').textContent = val;
            document.getElementById('preview-p1-end').textContent = val;
            document.getElementById('preview-p2-start').textContent = val + 1;
            
            const percent = ((val - 1) / (splitTotal - 1)) * 100;
            const pop = document.getElementById('slider-value-popover');
            // 簡易位置計算
            const sliderWidth = sSlider.clientWidth - 20; // thumb width approx
            const offset = (percent / 100) * sliderWidth;
            pop.style.left = `calc(${percent}% + (${10 - percent * 0.2}px))`;
            pop.style.opacity = '1';
            
            document.getElementById('preview-part1').style.flexGrow = val;
            document.getElementById('preview-part2').style.flexGrow = splitTotal - val;
        }

        // リセット関数 (Global scope for inline onclick)
        window.resetSplit = () => {
            splitFile = null;
            splitTotal = 0;
            sInput.value = '';
            updateSingleFileUI('split', null);
            updateBtnState('btn-exec-split', false);
            document.getElementById('split-range-input').classList.add('hidden');
            // ラジオボタンを初期値に戻す等は任意だが、ユーザーの選択を残すのがベター
        };

        sDrop.onclick = (e) => {
            if (e.target.closest('button')) return; // 削除ボタンクリック時はファイル選択を開かない
            if (!splitFile) sInput.click();
        };
        sInput.onchange = async (e) => {
            const f = e.target.files[0];
            if(!f || f.type !== 'application/pdf') return;
            toggleLoading(true);
            try {
                const doc = await PDFLib.PDFDocument.load(await f.arrayBuffer());
                splitTotal = doc.getPageCount();
                if(splitTotal < 2) { showToast('2ページ以上のPDFを選択してください', true); return; }
                splitFile = f;
                
                updateSingleFileUI('split', f, 'resetSplit');
                
                document.getElementById('total-pages-display').textContent = splitTotal;
                sSlider.max = splitTotal - 1; sSlider.value = Math.floor(splitTotal/2);
                
                toggleSplitInputs(); // スライダー表示更新
                updateBtnState('btn-exec-split', true);
                showToast('ファイルを読み込みました');
            } catch(err) { console.error(err); showToast('読み込み失敗', true); resetSplit(); } finally { toggleLoading(false); }
        };

        sSlider.oninput = updateSplitUI;
        function toggleSplitInputs() {
            if(!splitFile) return;
            const mode = document.querySelector('input[name="split-mode"]:checked').value;
            const rangeInput = document.getElementById('split-range-input');
            rangeInput.classList.toggle('hidden', mode !== 'range');
            if(mode === 'range') updateSplitUI();
        }

        document.getElementById('btn-exec-split').onclick = async () => {
            toggleLoading(true);
            try {
                const src = await PDFLib.PDFDocument.load(await splitFile.arrayBuffer());
                const mode = document.querySelector('input[name="split-mode"]:checked').value;
                const zip = new JSZip();
                const baseName = splitFile.name.replace(/\.pdf$/i, '');
                
                if(mode === 'all') {
                    for(let i=0; i<splitTotal; i++) {
                        const sub = await PDFLib.PDFDocument.create();
                        const [p] = await sub.copyPages(src, [i]); sub.addPage(p);
                        zip.file(`${baseName}_page-${i+1}.pdf`, await sub.save());
                    }
                } else {
                    const pos = parseInt(sSlider.value);
                    const sub1 = await PDFLib.PDFDocument.create();
                    const sub2 = await PDFLib.PDFDocument.create();
                    const p1 = await sub1.copyPages(src, Array.from({length:pos}, (_,i)=>i));
                    const p2 = await sub2.copyPages(src, Array.from({length:splitTotal-pos}, (_,i)=>i+pos));
                    p1.forEach(p=>sub1.addPage(p)); p2.forEach(p=>sub2.addPage(p));
                    zip.file(`${baseName}_part1(1-${pos}).pdf`, await sub1.save());
                    zip.file(`${baseName}_part2(${pos+1}-end).pdf`, await sub2.save());
                }
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `${baseName}-split.zip`);
                showToast('ZIPファイルをダウンロードしました');
            } catch(e) { showToast('エラーが発生しました', true); } finally { toggleLoading(false); }
        };

        // --- Organize Logic ---
        let orgFile = null;
        const oDrop = document.getElementById('drop-zone-organize');
        const oInput = document.getElementById('file-input-organize');
        const oGrid = document.getElementById('organize-grid');

        oDrop.onclick = () => oInput.click();
        oInput.onchange = async (e) => {
            const f = e.target.files[0];
            if(!f || f.type !== 'application/pdf') return;
            toggleLoading(true);
            try {
                const pdf = await pdfjsLib.getDocument({data: await f.arrayBuffer()}).promise;
                orgFile = f;
                document.getElementById('organize-step-1').classList.add('hidden');
                document.getElementById('organize-step-2').classList.remove('hidden');
                oGrid.innerHTML = '';
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale:0.4});
                    const card = document.createElement('div');
                    card.className = 'page-card bg-white p-2 rounded-lg border border-slate-200 cursor-pointer shadow-sm hover:ring-2 hover:ring-indigo-400 transition-all select-none relative group';
                    card.dataset.idx = i-1; card.dataset.rot = 0;
                    card.onclick = () => { card.classList.toggle('selected'); document.getElementById('org-selected-count').textContent = document.querySelectorAll('.page-card.selected').length; };
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    canvas.className = 'w-full h-auto rounded transition-transform duration-300';
                    card.appendChild(canvas);
                    const badge = document.createElement('div');
                    badge.className = 'absolute top-1 left-1 bg-slate-800/60 text-white text-[9px] px-1.5 py-0.5 rounded font-bold';
                    badge.textContent = i;
                    card.appendChild(badge);
                    oGrid.appendChild(card);
                    await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                }
                new Sortable(oGrid, { animation:150, ghostClass:'opacity-20' });
            } catch(err) { showToast('読み込み失敗', true); } finally { toggleLoading(false); }
        };

        window.orgRotate = (deg) => {
            document.querySelectorAll('.page-card.selected').forEach(card => {
                let r = (parseInt(card.dataset.rot) + deg) % 360;
                card.dataset.rot = r;
                card.querySelector('canvas').style.transform = `rotate(${r}deg)`;
            });
        };
        window.orgDelete = () => {
            const sel = document.querySelectorAll('.page-card.selected');
            if(sel.length > 0) { sel.forEach(c => c.remove()); showToast('削除しました'); }
        };
        window.resetOrganize = () => { document.getElementById('organize-step-2').classList.add('hidden'); document.getElementById('organize-step-1').classList.remove('hidden'); oInput.value=''; };

        document.getElementById('btn-exec-organize').onclick = async () => {
            toggleLoading(true);
            try {
                const src = await PDFLib.PDFDocument.load(await orgFile.arrayBuffer());
                const res = await PDFLib.PDFDocument.create();
                for(const card of oGrid.querySelectorAll('.page-card')) {
                    const [p] = await res.copyPages(src, [parseInt(card.dataset.idx)]);
                    p.setRotation(PDFLib.degrees(p.getRotation().angle + parseInt(card.dataset.rot)));
                    res.addPage(p);
                }
                saveAs(new Blob([await res.save()], {type:'application/pdf'}), `organized-${orgFile.name}`);
                showToast('保存しました！');
            } catch(e) { showToast('保存に失敗しました', true); } finally { toggleLoading(false); }
        };

        // --- Other Tabs (Convert, Number) ---
        // Convert: Img to PDF (Multiple files - List UI like Merge)
        let imgFiles = [];
        const dropImg2Pdf = document.getElementById('drop-zone-img2pdf');
        const inputImg2Pdf = document.getElementById('file-input-img2pdf');
        const listImg2Pdf = document.getElementById('list-img2pdf');

        function renderImgList() {
            listImg2Pdf.innerHTML = '';
            if(imgFiles.length === 0) {
                listImg2Pdf.appendChild(document.getElementById('empty-img2pdf'));
                updateBtnState('btn-exec-img2pdf', false);
                document.getElementById('clear-img2pdf').classList.add('hidden');
            } else {
                updateBtnState('btn-exec-img2pdf', true);
                document.getElementById('clear-img2pdf').classList.remove('hidden');
                imgFiles.forEach((f, i) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center gap-3 bg-white p-3 border border-slate-100 rounded-lg hover:shadow-md transition-shadow select-none animate-fade-in';
                    el.innerHTML = `
                        <div class="drag-handle-img cursor-grab text-slate-300 px-1"><i class="fa-solid fa-grip-lines"></i></div>
                        <img src="${URL.createObjectURL(f.file)}" class="w-8 h-8 object-cover rounded bg-slate-100">
                        <div class="flex-1 truncate text-sm font-medium text-slate-700">${f.name}</div>
                        <button onclick="imgFiles.splice(${i},1);renderImgList();" class="text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
                    `;
                    listImg2Pdf.appendChild(el);
                });
                new Sortable(listImg2Pdf, { handle:'.drag-handle-img', animation:150, onEnd:(evt)=>{
                    const item = imgFiles.splice(evt.oldIndex, 1)[0]; imgFiles.splice(evt.newIndex, 0, item); renderImgList();
                }});
            }
            document.getElementById('count-img2pdf').textContent = imgFiles.length;
        }
        dropImg2Pdf.onclick = () => inputImg2Pdf.click();
        inputImg2Pdf.onchange = (e) => {
            Array.from(e.target.files).forEach(f => {
                if(f.type.startsWith('image/')) imgFiles.push({id:Math.random(), name:f.name, file:f});
            });
            renderImgList(); inputImg2Pdf.value = '';
        };
        document.getElementById('clear-img2pdf').onclick = () => { imgFiles = []; renderImgList(); };
        document.getElementById('btn-exec-img2pdf').onclick = async () => {
            toggleLoading(true);
            try {
                const pdf = await PDFLib.PDFDocument.create();
                for(const obj of imgFiles) {
                    const img = obj.file.type.includes('jpeg') ? await pdf.embedJpg(await obj.file.arrayBuffer()) : await pdf.embedPng(await obj.file.arrayBuffer());
                    const page = pdf.addPage([img.width, img.height]);
                    page.drawImage(img, {x:0, y:0, width:img.width, height:img.height});
                }
                saveAs(new Blob([await pdf.save()], {type:'application/pdf'}), `images-${Date.now()}.pdf`);
                showToast('変換完了！');
            } catch(e) { showToast('エラー', true); } finally { toggleLoading(false); }
        };

        // Convert: PDF to Img (Single File)
        let pdf2imgFile = null;
        const dropPdf2Img = document.getElementById('drop-zone-pdf2img');
        const inputPdf2Img = document.getElementById('file-input-pdf2img');
        
        window.resetPdf2Img = () => {
            pdf2imgFile = null;
            inputPdf2Img.value = '';
            updateSingleFileUI('pdf2img', null);
            updateBtnState('btn-exec-pdf2img', false);
        };

        dropPdf2Img.onclick = (e) => {
            if(e.target.closest('button')) return;
            if(!pdf2imgFile) inputPdf2Img.click();
        };
        inputPdf2Img.onchange = (e) => {
            const f = e.target.files[0];
            if(f && f.type === 'application/pdf') {
                pdf2imgFile = f;
                updateSingleFileUI('pdf2img', f, 'resetPdf2Img');
                updateBtnState('btn-exec-pdf2img', true);
            }
        };
        document.getElementById('btn-exec-pdf2img').onclick = async () => {
            toggleLoading(true);
            try {
                const pdf = await pdfjsLib.getDocument({data: await pdf2imgFile.arrayBuffer()}).promise;
                const zip = new JSZip();
                const baseName = pdf2imgFile.name.replace(/\.pdf$/i, '');

                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale:2.0});
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                    zip.file(`${baseName}_page-${i}.jpg`, await new Promise(r=>canvas.toBlob(r, 'image/jpeg', 0.85)));
                }
                saveAs(await zip.generateAsync({type:'blob'}), `${baseName}-images.zip`);
                showToast('ZIPファイルをダウンロードしました');
            } catch(e) { console.error(e); showToast('エラーが発生しました', true); } finally { toggleLoading(false); }
        };

        window.toggleConvertMode = (mode) => {
            // 表示切り替え
            document.getElementById('convert-img2pdf').classList.toggle('hidden', mode !== 'img2pdf');
            document.getElementById('convert-img2pdf').style.display = mode === 'img2pdf' ? 'flex' : 'none';
            document.getElementById('convert-pdf2img').classList.toggle('hidden', mode !== 'pdf2img');
            document.getElementById('convert-pdf2img').style.display = mode === 'pdf2img' ? 'flex' : 'none';

            // ボタンのスタイル定義
            const activeClassList = ['bg-indigo-100', 'text-indigo-700', 'shadow-sm', 'border', 'border-indigo-200', 'font-bold'];
            const inactiveClassList = ['text-slate-500', 'hover:bg-white/50', 'font-medium'];

            const btnImg = document.getElementById('btn-mode-img2pdf');
            const btnPdf = document.getElementById('btn-mode-pdf2img');

            if (mode === 'img2pdf') {
                btnImg.classList.add(...activeClassList);
                btnImg.classList.remove(...inactiveClassList);
                
                btnPdf.classList.remove(...activeClassList);
                btnPdf.classList.add(...inactiveClassList);
            } else {
                btnPdf.classList.add(...activeClassList);
                btnPdf.classList.remove(...inactiveClassList);
                
                btnImg.classList.remove(...activeClassList);
                btnImg.classList.add(...inactiveClassList);
            }
        };

        // --- Number (Single File) ---
        let numberFile = null;
        const dropNumber = document.getElementById('drop-zone-number');
        const inputNumber = document.getElementById('file-input-number');

        window.resetNumber = () => {
            numberFile = null;
            inputNumber.value = '';
            updateSingleFileUI('number', null);
            updateBtnState('btn-exec-number', false);
        };

        dropNumber.onclick = (e) => {
            if(e.target.closest('button')) return;
            if(!numberFile) inputNumber.click();
        };
        inputNumber.onchange = (e) => {
            const f = e.target.files[0];
            if(f && f.type === 'application/pdf') {
                numberFile = f;
                updateSingleFileUI('number', f, 'resetNumber');
                updateBtnState('btn-exec-number', true);
            }
        };
        document.getElementById('btn-exec-number').onclick = async () => {
            toggleLoading(true);
            try {
                const doc = await PDFLib.PDFDocument.load(await numberFile.arrayBuffer());
                const font = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
                const size = parseInt(document.getElementById('num-size').value);
                const pos = document.getElementById('num-position').value;
                const fmt = document.querySelector('input[name="num-format"]:checked').value;
                const total = doc.getPageCount();
                
                doc.getPages().forEach((p, i) => {
                    const text = fmt === 'page_total' ? `${i+1} / ${total}` : `${i+1}`;
                    const width = font.widthOfTextAtSize(text, size);
                    const {width:pw, height:ph} = p.getSize();
                    let x = 20, y = 20;
                    if(pos.includes('top')) y = ph - 20 - size;
                    if(pos.includes('center')) x = (pw - width) / 2;
                    if(pos.includes('right')) x = pw - 20 - width;
                    p.drawText(text, {x, y, size, font});
                });
                saveAs(new Blob([await doc.save()], {type:'application/pdf'}), `numbered-${Date.now()}.pdf`);
                showToast('完了！');
            } catch(e) { showToast('エラー', true); } finally { toggleLoading(false); }
        };

        // Initialize drag & drop visuals
        ['merge', 'split', 'organize', 'img2pdf', 'pdf2img', 'number'].forEach(id => {
            const zone = document.getElementById(`drop-zone-${id}`);
            if(!zone) return;
            zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('drag-active'); };
            zone.ondragleave = () => zone.classList.remove('drag-active');
            zone.ondrop = (e) => {
                e.preventDefault(); zone.classList.remove('drag-active');
                const input = document.getElementById(`file-input-${id === 'img2pdf' ? 'img2pdf' : (id === 'pdf2img' ? 'pdf2img' : id)}`);
                // Check if input is active (not replaced by UI)
                if(input) {
                    input.files = e.dataTransfer.files;
                    input.onchange({target: input});
                }
            };
        });
        
        document.addEventListener('DOMContentLoaded', () => switchTab('merge'));

    </script>
</body>
</html>
